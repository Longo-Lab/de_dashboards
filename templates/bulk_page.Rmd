{{r}}
=======================================================================


Row {.tabset .tabset-fade}
-------------------------------------
    
```{r {{r}}-fig, include = F}
# Generate module tabs
tabs <- NULL

imgs <- str_c(
  file.path(seurat_dir, nameset, filedate), 
  # nameset,
  '{{r}}',
  c('TREAT-AD', 'TMT-AD', 'Mostafavi_etal', 'Milind_etal', 'Wan_etal'), 
  'Modules_Up-Down.logfdr.png',
  sep = '.'
)
names(imgs) <- c('Treat-AD', 'Tmt-AD', 'Mostafavi, et al.', 'Milind, et al.', 'Wan, et al.')

for (i in names(imgs)) {
  tabs <- c(tabs, knit_expand(file = file.path(templates_dir, 'tab.Rmd')))
}
```

`r paste(knit(text = tabs), collapse = '\n')`

### Treat-AD correlation

```{r {{r}}-corr}
knitr::include_graphics(
  str_c(
    file.path(seurat_dir, nameset, filedate), 
    # nameset, 
    '{{r}}.TREAT-AD.correlations.png',
    sep = '.'
  )
)
```

### L2FC correlation

```{r {{r}}-lfc-corr, fig.width = 5}
drug_df <- genes_files[['{{r}}']][['drug']] ##### may want to pass this function results dt
geno_df <- genes_files[['{{r}}']][['geno']]

both <- merge(drug_df, geno_df, by = 'Gene_id', suffix = c('.drug', '.geno'))
both <- both[(pvalue.drug < 0.05 & pvalue.geno < 0.05)]  # not adjusted p-val

res <- cor.test(both[['log2FoldChange.drug']], both[['log2FoldChange.geno']])

sub <- sprintf('R = %.3f; p < %.3g', res$estimate[[1]], res$p.value)
gg_fig <- both %>% 
  ggplot(aes(x = log2FoldChange.drug, y = log2FoldChange.geno)) +
  geom_point(color = NA) +
  geom_hline(yintercept = 0, linetype = 'dashed', col = 'gray') +
  geom_vline(xintercept = 0, linetype = 'dashed', col = 'gray') +
  geom_ribbon(stat = 'smooth', method = 'lm', alpha = 0.5, fill = '#fee0b6') +
  geom_smooth(method = 'lm', se = F, color = '#053061') + 
  xlab(str_c('log2FoldChange', drug, sep = '.')) +
  ylab(str_c('log2FoldChange', geno, sep = '.')) +
  theme_classic()

both_sig <- both %>% 
  filter(abs(log2FoldChange.drug) > 2.0 | abs(log2FoldChange.geno) > 2.5)

ggplotly(gg_fig, tooltip = 'none') %>% 
  add_markers(
    x = both$log2FoldChange.drug, 
    y = both$log2FoldChange.geno, 
    color = I('#8073ac'),
    hovertemplate = str_c(
      '<br><b>', both$GeneSymbol.geno, '</b>',
      '<br>', drug, ' L2FC: ', round(both$log2FoldChange.drug, 3),
      '<br>', drug, ' p: ', signif(both$pvalue.drug, 3),
      '<br>', geno, ' L2FC: ', round(both$log2FoldChange.geno, 3), 
      '<br>', geno, ' p: ', signif(both$pvalue.geno, 3), 
      '<extra></extra>'
    )
  ) %>% 
  add_text(
    x = both_sig$log2FoldChange.drug,
    y = both_sig$log2FoldChange.geno,
    text = both_sig$GeneSymbol.geno,
    textfont = list(size = 10),
    textposition = 'top middle'
  ) %>% add_annotations(
    x = 0,
    y = 0,
    xanchor = 'left',
    xref = 'paper',
    yref = 'paper',
    text = sub,
    showarrow = F,
    font = list(color = 'gray', size = 15)
  )
```

```{r {{r}}-gprofiler, include = F}
dir_enh <- results[['{{r}}']][category == 'enhancement' & direct == T][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.drug)))]
dir_sup <- results[['{{r}}']][category == 'suppression' & direct == T][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.drug)))]

indir_enh <- results[['{{r}}']][category == 'enhancement' & direct == F][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.geno_drug)))]
indir_sup <- results[['{{r}}']][category == 'suppression' & direct == F][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.geno_drug)))]

enh <- c(dir_enh, indir_enh)
sup <- c(dir_sup, indir_sup)

comp_enh <- results[['{{r}}']][category == 'compensatory enhancement'][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.drug)))]
comp_sup <- results[['{{r}}']][category == 'compensatory suppression'][order(-(abs(log2FoldChange.geno) + abs(log2FoldChange.drug)))]


# Generate gProfiler tabs
gprofilers <- NULL

gp_enhs <- list(enh, dir_enh, comp_enh)
gp_sups <- list(sup, dir_sup, comp_sup)
gp_names <- c('', 'direct', 'compensatory')
gp_abbrevs <- c('indir + dir', 'dir', 'comp')

for (i in seq(gp_names)) {
  gprofilers <- c(gprofilers, knit_expand(file = file.path(templates_dir, 'gprofiler.Rmd')))
}
```

`r paste(knit(text = gprofilers), collapse = '\n')`


Row {.tabset .tabset-fade data-height=470}
-------------------------------------

### Genes list

```{r {{r}}-tbl}
sketch <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Ensembl ID'),
      th(rowspan = 2, 'Symbol'),
      th(rowspan = 2, 'Category'),
      th(rowspan = 2, 'Direct'),
      th(colspan = 3, style = 'background-color:#f3f7eb;border-bottom:none;', geno),
      th(colspan = 3, style = 'background-color:#fdf2f1;border-bottom:none;', str_c(geno, drug, sep = '_')),
      th(colspan = 3, style = 'background-color:#eef8f9;border-bottom:none;', drug),
      th(colspan = 5, style = 'background-color:#eeeeee;border-bottom:none;', 'Modules')
    ),
    tr(
      lapply(rep(c('Log2FC', 'Padj', 'P'), 3), th),
      th('TreatAD'),
      th('TmtAD'),
      th('Mostafavi'),
      th('Milind'),
      th('Wan')
    )
  )
))

render_tooltip <- "
function(row, data) {

  // 2nd column (Ensembl gene info)
  var info = data[1].split('|'),
      title = 'Chromosome: ' + info[2] + '&#010;Biotype: ' + info[1];
  
  $('td:eq(1)', row)
    .html('<span class=\"tbl-info\" title=\"' + title + '\">' + info[0] + '</span>');
    
  // 14th-18th columns (modules)
  for (var i = 13; i < 18; i++) {
    var modules = data[i] ? data[i].split('|')[1].split(',') : [];

    $('td:eq(' + i + ')', row).
      html('<span class=\"tbl-info\" title=\"' + modules.join('&#010;') + '\">' + modules.length + '</span>');
  }

}
"

add_count <- function(x) {
  str_c(str_pad(str_count(x, ',') + 1, width = 2, side = 'left', pad = '0'), x, sep = '|')
}

results[['{{r}}']] %>% 
  # filter(!is.na(category)) %>%
  mutate(
    ensembl_gene_id = str_c('<a href="https://www.ncbi.nlm.nih.gov/gene/?term=', ensembl_gene_id, '">', ensembl_gene_id, '</a>'),
    external_gene_name = str_c(external_gene_name, gene_biotype, chromosome_name, sep = '|'),
    category = factor(category),
    treatAD = add_count(treatAD),
    tmtAD = add_count(tmtAD),
    mostafavi = add_count(mostafavi),
    milind = add_count(milind),
    wan = add_count(wan)
  ) %>% 
  dplyr::select(-gene_biotype, -chromosome_name) %>% 
  datatable(
    rownames = F, 
    filter = 'top',
    container = sketch,
    class = 'compact', 
    escape = F,
    options = list(
      dom = 'tip',
      rowCallback = JS(render_tooltip),
      columnDefs = list(
        list(targets = 16:20, className = 'dt-right')
      )
    )
  ) %>% 
  formatRound(grep('log2FoldChange', names(results[['{{r}}']]), value = T), 3) %>% 
  formatSignif(grep('padj', names(results[['{{r}}']]), value = T), 3) %>% 
  formatSignif(grep('pvalue', names(results[['{{r}}']]), value = T), 3) 
```

### Summary table

```{r {{r}}-summary}
results[['{{r}}']][order(-category, -direct), .N, by = c('category', 'direct')] %>%
  kable('html', escape = F) %>% 
  kable_styling(bootstrap_options = c('hover', 'condensed'), full_width = F)
```
